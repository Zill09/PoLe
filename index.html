<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pojok Lelucon</title>

<style>
body{font-family:sans-serif;margin:0;background:#f4f6fb}
header{background:#6c63ff;color:white;padding:15px;text-align:center}
.container{max-width:700px;margin:auto;padding:20px}
.card{background:white;padding:15px;border-radius:10px;margin-bottom:15px}
textarea,input{width:100%;padding:8px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
button{padding:6px 10px;border:none;border-radius:6px;background:#6c63ff;color:white;cursor:pointer;margin-top:5px}
.like{background:transparent;color:crimson}
.meta{font-size:12px;color:#777;display:flex;justify-content:space-between}
.comment{background:#f1f1f1;padding:6px;border-radius:6px;margin-top:5px;font-size:13px}
</style>
</head>
<body>

<header>üé™ Pojok Lelucon</header>

<div class="container">

<div class="card">
<h3>Tulis Lelucon</h3>
<input type="text" id="username" placeholder="Nama kamu">
<textarea id="jokeText" rows="3" placeholder="Tulis lelucon..."></textarea>
<button onclick="addJoke()">Posting</button>
</div>

<div id="jokeList"></div>

</div>

<script>

const GITHUB_USERNAME = "USERNAME_GITHUB";
const REPO_NAME = "REPO_NAME";
const TOKEN = "TOKEN_KAMU";
const FILE_PATH = "data.json";

let data = { jokes: [] };

// Anti spam (1 post tiap 30 detik)
let lastPostTime = 0;

async function loadData(){
  const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`);
  const file = await res.json();
  const content = atob(file.content);
  data = JSON.parse(content);
  window.fileSha = file.sha;
  render();
}

async function saveData(){
  await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`,{
    method:"PUT",
    headers:{
      "Authorization":"token "+TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      message:"update jokes",
      content:btoa(JSON.stringify(data,null,2)),
      sha:window.fileSha
    })
  });
  loadData();
}

function generateUserId(){
  let id = localStorage.getItem("userId");
  if(!id){
    id = "user-"+Date.now()+Math.random();
    localStorage.setItem("userId",id);
  }
  return id;
}

function addJoke(){
  if(Date.now()-lastPostTime < 30000){
    alert("Tunggu 30 detik sebelum posting lagi.");
    return;
  }

  const username = document.getElementById("username").value.trim();
  const text = document.getElementById("jokeText").value.trim();
  if(!username || !text) return alert("Isi semua dulu.");

  data.jokes.unshift({
    id:Date.now(),
    username,
    text,
    likes:0,
    likedBy:[],
    views:0,
    viewedBy:[],
    comments:[],
    date:new Date().toLocaleString()
  });

  lastPostTime = Date.now();
  saveData();
}

function likeJoke(id){
  const joke = data.jokes.find(j=>j.id===id);
  const userId = generateUserId();
  if(joke.likedBy.includes(userId)) return alert("Sudah like.");
  joke.likes++;
  joke.likedBy.push(userId);
  saveData();
}

function addComment(id){
  const commentText = document.getElementById("c"+id).value.trim();
  if(!commentText) return;

  const joke = data.jokes.find(j=>j.id===id);
  joke.comments.push({
    text:commentText,
    date:new Date().toLocaleString()
  });

  saveData();
}

function render(){
  const container=document.getElementById("jokeList");
  container.innerHTML="";

  data.jokes.forEach(joke=>{
    const userId = generateUserId();
    if(!joke.viewedBy.includes(userId)){
      joke.views++;
      joke.viewedBy.push(userId);
    }

    const div=document.createElement("div");
    div.className="card";

    div.innerHTML=`
      <div class="meta">
        <span>${joke.username}</span>
        <span>${joke.date}</span>
      </div>
      <p>${joke.text}</p>
      <button class="like" onclick="likeJoke(${joke.id})">
        ‚ù§Ô∏è (${joke.likes})
      </button>
      <span> üëÅÔ∏è ${joke.views}</span>

      <div>
        <input id="c${joke.id}" placeholder="Tulis komentar...">
        <button onclick="addComment(${joke.id})">Kirim</button>
      </div>

      ${joke.comments.map(c=>`<div class="comment">${c.text}</div>`).join("")}
    `;

    container.appendChild(div);
  });

  saveData();
}

loadData();

</script>

</body>
  </html>
