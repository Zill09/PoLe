<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pojok Lelucon Online</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
body{font-family:sans-serif;margin:0;background:#f4f6fb}
header{background:#6c63ff;color:white;padding:15px;text-align:center}
.container{max-width:700px;margin:auto;padding:20px}
.card{background:white;padding:15px;border-radius:10px;margin-bottom:15px}
button{padding:8px 12px;border:none;border-radius:6px;background:#6c63ff;color:white;cursor:pointer}
input,textarea{width:100%;padding:8px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
.like{background:transparent;color:crimson}
.meta{font-size:12px;color:#777;display:flex;justify-content:space-between}
</style>
</head>
<body>

<header>ğŸª Pojok Lelucon Online</header>

<div class="container">

<div id="authSection" class="card">
<h3>Login / Register</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="register()">Register</button>
<button onclick="login()">Login</button>
</div>

<div id="appSection" style="display:none;">
<div class="card">
<textarea id="jokeText" rows="3" placeholder="Tulis leluconmu..."></textarea>
<button onclick="addJoke()">Posting</button>
<button onclick="logout()">Logout</button>
</div>
<div id="jokeList"></div>
</div>

</div>

<script type="module">

// ğŸ”¥ GANTI DENGAN CONFIG MILIKMU
const firebaseConfig = {
  apiKey: "ISI_API_KEY",
  authDomain: "ISI_AUTH_DOMAIN",
  projectId: "ISI_PROJECT_ID",
  storageBucket: "ISI_STORAGE",
  messagingSenderId: "ISI_SENDER_ID",
  appId: "ISI_APP_ID"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, arrayUnion } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.register = async function(){
  await createUserWithEmailAndPassword(auth,
    email.value,
    password.value
  );
};

window.login = async function(){
  await signInWithEmailAndPassword(auth,
    email.value,
    password.value
  );
};

window.logout = async function(){
  await signOut(auth);
};

onAuthStateChanged(auth, user=>{
  if(user){
    authSection.style.display="none";
    appSection.style.display="block";
    loadJokes();
  }else{
    authSection.style.display="block";
    appSection.style.display="none";
  }
});

window.addJoke = async function(){
  if(!jokeText.value) return;
  await addDoc(collection(db,"jokes"),{
    text:jokeText.value,
    user:auth.currentUser.uid,
    email:auth.currentUser.email,
    likes:0,
    likedBy:[],
    views:0,
    viewedBy:[],
    date:new Date()
  });
  jokeText.value="";
  loadJokes();
};

async function loadJokes(){
  jokeList.innerHTML="";
  const snapshot = await getDocs(collection(db,"jokes"));
  snapshot.forEach(async docSnap=>{
    const data = docSnap.data();
    const id = docSnap.id;

    // VIEW unik
    if(!data.viewedBy.includes(auth.currentUser.uid)){
      await updateDoc(doc(db,"jokes",id),{
        views:data.views+1,
        viewedBy:arrayUnion(auth.currentUser.uid)
      });
      data.views++;
    }

    const liked = data.likedBy.includes(auth.currentUser.uid);

    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <div class="meta">
        <span>${data.email}</span>
        <span>${new Date(data.date.seconds*1000).toLocaleString()}</span>
      </div>
      <p>${data.text}</p>
      <button class="like" onclick="likeJoke('${id}',${data.likes},${liked})">
      ${liked?"ğŸ’– Sudah Like":"â¤ï¸ Like"} (${data.likes})
      </button>
      <span> ğŸ‘ï¸ ${data.views}</span>
    `;
    jokeList.appendChild(div);
  });
}

window.likeJoke = async function(id,likes,liked){
  if(liked) return alert("Sudah like.");
  await updateDoc(doc(db,"jokes",id),{
    likes:likes+1,
    likedBy:arrayUnion(auth.currentUser.uid)
  });
  loadJokes();
};

</script>

</body>
</html>
