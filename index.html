<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pojok Lelucon</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:sans-serif;margin:0;background:#f4f6fb}
header{background:#6c63ff;color:white;padding:15px;text-align:center}
.container{max-width:700px;margin:auto;padding:20px}
.card{background:white;padding:15px;border-radius:10px;margin-bottom:15px}
textarea,input{width:100%;padding:8px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
button{padding:6px 10px;border:none;border-radius:6px;background:#6c63ff;color:white;cursor:pointer;margin-top:5px}
.meta{font-size:12px;color:#777;display:flex;justify-content:space-between}
.comment{background:#f1f1f1;padding:5px;border-radius:5px;margin-top:5px}
</style>
</head>
<body>

<header>üé™ Pojok Lelucon</header>

<div class="container">

<div class="card">
<input id="username" placeholder="Nama kamu">
<textarea id="content" placeholder="Tulis lelucon..."></textarea>
<button onclick="addJoke()">Posting</button>
</div>

<div id="list"></div>

</div>

<script>

const supabase = window.supabase.createClient(
  "https://esktafrjozqjuaxqptxd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVza3RhZnJqb3pxanVheHFwdHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMTQyMDcsImV4cCI6MjA4Njc5MDIwN30.NqoCsfGc8Az_DGutakVRBuAySmOtAS7DEdoFvB7VGk0"
);

let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
  deviceId = "dev-"+Date.now()+Math.random();
  localStorage.setItem("deviceId", deviceId);
}

async function addJoke(){
  const username = document.getElementById("username").value.trim();
  const content = document.getElementById("content").value.trim();
  if(!username || !content) return alert("Isi dulu.");

  await supabase.from("jokes").insert([
    { username, content }
  ]);

  document.getElementById("content").value="";
  loadJokes();
}

async function likeJoke(id, currentLikes){
  await supabase.from("jokes")
    .update({ likes: currentLikes + 1 })
    .eq("id", id);

  loadJokes();
}

async function loadJokes(){
  const { data, error } = await supabase
  .from("jokes")
  .insert([{ name: name, joke: joke }]);

if (error) {
  alert("Error: " + error.message);
  console.log(error);
} else {
  alert("Berhasil terkirim!");
  }

  const container = document.getElementById("list");
  container.innerHTML="";

  for(const joke of data){

    await supabase.from("jokes")
      .update({ views: joke.views + 1 })
      .eq("id", joke.id);

    const { data: comments } = await supabase
      .from("comments")
      .select("*")
      .eq("joke_id", joke.id);

    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <div class="meta">
        <span>${joke.username}</span>
        <span>${new Date(joke.created_at).toLocaleString()}</span>
      </div>
      <p>${joke.content}</p>
      <button onclick="likeJoke(${joke.id},${joke.likes})">
        ‚ù§Ô∏è ${joke.likes}
      </button>
      <span> üëÅÔ∏è ${joke.views}</span>

      <div>
        <input id="c${joke.id}" placeholder="Komentar...">
        <button onclick="addComment(${joke.id})">Kirim</button>
      </div>

      ${(comments||[]).map(c=>`<div class="comment">${c.username}: ${c.content}</div>`).join("")}
    `;
    container.appendChild(div);
  }
}

async function addComment(jokeId){
  const text = document.getElementById("c"+jokeId).value.trim();
  if(!text) return;

  await supabase.from("comments").insert([
    { joke_id:jokeId, username:"Anon", content:text }
  ]);

  loadJokes();
}

loadJokes();

</script>

</body>
  </html>
